// SPDX-License-Identifier: UNLICENSED
// --- Boilerplate ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

enum UserRole {
  SUPER_ADMIN // System-wide admin
  ADMIN       // Company-level admin
  EMPLOYEE    // Standard employee user
}

enum PayrollStatus {
  DRAFT             // Payroll generated but not yet finalized for approval
  PENDING_APPROVAL  // Submitted for approval
  APPROVED          // Approved, ready for payment processing
  REJECTED          // Approval denied
  PROCESSING_PAYMENT// Payment initiated (optional state)
  PAID              // Payment successfully completed
  PAYMENT_FAILED    // Payment attempt failed
  CANCELLED         // Payroll run cancelled before payment
}



// Invitation lifecycle tracking
enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum PayFrequency { // Renamed from PayFrquency
  WEEKLY
  BI_WEEKLY // Every two weeks
  SEMI_MONTHLY // Twice a month (e.g., 15th and last day)
  MONTHLY
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN // Added example
}

enum PayType {
  SALARY
  HOURLY
}

// --- NEW: Leave Management Enums ---
enum LeaveType {
  ANNUAL
  SICK
  UNPAID
  MATERNITY
  PATERNITY
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED // By employee or admin before approval
}

// --- Core Models ---

model Company {
  id           String       @id @default(uuid()) @db.Uuid
  name         String       @db.VarChar(255)
  email        String       @unique @db.VarChar(255) // Company contact email
  payFrequency PayFrequency @default(MONTHLY) // Corrected enum name
  taxIdNumber  String?      // e.g., Employer Identification Number (EIN) in US

  // Relationships
  users       User[]       // Users linked to this company
  employees   Employee[]   // Employees belonging to this company
  payrolls    Payroll[]    // Payrolls run by this company
  invitations Invitation[] // Invitations sent by this company

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@map("companies")
}

/// Represents a user account that can log in to the system.
model User {
  id         String   @id @default(uuid()) @db.Uuid
  email      String   @unique @db.VarChar(255) // Login email
  password   String   @db.VarChar(255) // Stored HASH - ensure application hashes it!
  isVerified Boolean  @default(false) // Email verification status
  role       UserRole @default(EMPLOYEE)

  // Relationships
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  companyId String?  @db.Uuid

  // One-to-one link: User might be an Admin without an Employee record.
  employee Employee? @relation("UserEmployee") // Named relation for 1-to-1

  // Invitations
  acceptedInvitation Invitation? @relation("AcceptedByUser") // Link to the invitation they accepted
  invitationsSent    Invitation[] @relation("InvitedByUser") // Invitations sent *by* this user (e.g., Admin)

  // Payroll Actions (Audit Trail)
  generatedPayrolls Payroll[] @relation("GeneratedByUser")
  approvedPayrolls  Payroll[] @relation("ApprovedByUser")
  paidPayrolls      Payroll[] @relation("PaidByUser")
  cancelledPayrolls Payroll[] @relation("CancelledByUser")

  // NEW: Leave Actions (Audit Trail)
  approvedLeaveRequests LeaveRequest[] @relation("ApprovedLeaveByUser")
  rejectedLeaveRequests LeaveRequest[] @relation("RejectedLeaveByUser")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit logs created by this user
  auditLogs AuditLog[]

  @@index([email])
  @@index([companyId])
  @@map("users")
}

/// Represents an employee record, containing employment and basic payroll details.
model Employee {
  id            String         @id @default(uuid()) @db.Uuid
  firstName     String         @db.VarChar(100)
  lastName      String         @db.VarChar(100)
  email         String         @unique @db.VarChar(255) // Employee's contact email (can differ from User.email)
  jobTitle      String?
  department    String?
  employmentType EmploymentType @default(FULL_TIME)
  isActive      Boolean        @default(true) // For filtering active employees for payroll
  startDate     DateTime?      // Employment start date
  endDate       DateTime?      // Employment end date (use instead of terminationDate for consistency)

  // Payroll Information
  payType   PayType  @default(SALARY)   // SALARY or HOURLY
  salary    Decimal? @db.Decimal(12, 2) // Annual salary (if PayType=SALARY)
  payRate   Decimal? @db.Decimal(10, 2) // Hourly rate (if PayType=HOURLY)
  // Removed taxFileNumber - keep schema simple, assume handled externally or in specific payroll runs if needed

  // Bank Details (Optional - consider encryption at application level if sensitive)
  bankName          String?
  bankAccountNumber String?
  // Add bank routing/sort code if needed

  // Relationships
  company   Company @relation(fields: [companyId], references: [id], onDelete: Restrict) // Employee must belong to a company
  companyId String  @db.Uuid

  // Optional one-to-one link to User account
  user   User?   @relation("UserEmployee", fields: [userId], references: [id], onDelete: SetNull) // Link to login account
  userId String? @unique @db.Uuid // Foreign key for the 1-to-1 relation

  payrolls      EmployeePayroll[] // Payroll history for this employee
  // Simplified: Removed direct links to Benefit/Deduction models

  // NEW: Leave Management Relationships
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[] @relation("LeaveRequestedByEmployee")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([companyId, isActive]) // Important for fetching active employees for payroll
  @@index([endDate])
  @@map("employees")
}

/// Represents an invitation to join a company.
model Invitation {
  id        String       @id @default(uuid()) @db.Uuid
  email     String       @db.VarChar(255) // Email invited
  token     String       @unique @db.VarChar(255) // Secure, unique token for the invite link
  role      UserRole     @default(EMPLOYEE) // Role assigned upon acceptance
  status    InviteStatus @default(PENDING)
  expiresAt DateTime     // Invitations should expire

  // Relationships
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String  @db.Uuid

  // Optional: Track who sent the invite
  invitedById String? @db.Uuid
  invitedByUser User? @relation("InvitedByUser", fields: [invitedById], references: [id], onDelete: SetNull)

  // Optional & Unique: Track who accepted the invite
  acceptedByUserId String? @unique @db.Uuid
  acceptedByUser   User?   @relation("AcceptedByUser", fields: [acceptedByUserId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, companyId, status]) // Allow re-inviting if previous was CANCELLED/EXPIRED
  @@index([token])
  @@index([companyId])
  @@index([status])
  @@map("invitations")
}

/// Represents a payroll run for a company covering a specific period.
model Payroll {
  id          String        @id @default(uuid()) @db.Uuid
  periodStart DateTime      // Start date of the pay period
  periodEnd   DateTime      // End date of the pay period
  paymentDate DateTime?     // Target date for payment disbursement
  status      PayrollStatus @default(DRAFT) // Tracks the state of the payroll run

  // Aggregated Totals (Calculated during generation/processing)
  totalGross      Decimal? @db.Decimal(14, 2)
  totalDeductions Decimal? @db.Decimal(14, 2)
  totalNet        Decimal? @db.Decimal(14, 2)
  totalTaxes      Decimal? @db.Decimal(14, 2) // If calculating taxes internally
  employeeCount   Int?     // Number of employees included

  notes String? @db.Text // For admin notes, reasons for rejection/cancellation etc.

  // Relationships
  company   Company @relation(fields: [companyId], references: [id], onDelete: Restrict) // Payroll MUST belong to a company
  companyId String  @db.Uuid

  details EmployeePayroll[] // Line items for each employee in this run

  // Audit Trail Fields
  generatedById String?   @db.Uuid
  generatedBy   User?     @relation("GeneratedByUser", fields: [generatedById], references: [id], onDelete: SetNull)
  generatedAt   DateTime? // When the draft was first generated

  approvedById String?   @db.Uuid
  approvedBy   User?     @relation("ApprovedByUser", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt   DateTime?

  paidById    String?   @db.Uuid // Could be a user or system ID
  paidBy      User?     @relation("PaidByUser", fields: [paidById], references: [id], onDelete: SetNull)
  paidAt      DateTime? // Actual timestamp of payment processing completion

  cancelledById String?   @db.Uuid
  cancelledBy   User?     @relation("CancelledByUser", fields: [cancelledById], references: [id], onDelete: SetNull)
  cancelledAt   DateTime?

  // Timestamps
  createdAt DateTime @default(now()) // When the record was created (initial draft start)
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([companyId, periodStart, periodEnd])
  @@index([paymentDate])
  @@map("payrolls")
}

/// Junction Table: Details for a specific employee within a specific payroll run (Forms the Payslip data).
model EmployeePayroll {
  id String @id @default(uuid()) @db.Uuid

  // Core Pay Calculation
  grossAmount   Decimal  @db.Decimal(12, 2) // Total earnings before any deductions
  netAmount     Decimal  @db.Decimal(12, 2) // Take-home pay (Gross - Deductions - Taxes)

  // Earnings Breakdown (Examples)
  regularHoursWorked Decimal? @db.Decimal(6, 2)
  regularPayAmount   Decimal? @db.Decimal(12, 2) // Calculated from hours * rate or salary portion
  overtimeHours      Decimal? @db.Decimal(6, 2)
  overtimePayAmount  Decimal? @db.Decimal(12, 2)
  bonusAmount        Decimal? @db.Decimal(12, 2)
  commissionAmount   Decimal? @db.Decimal(12, 2)
  // Add other earnings types as needed (e.g., Allowances)

  // Deductions & Taxes (Store final calculated amounts)
  totalDeductions Decimal  @db.Decimal(12, 2) // Sum of all non-tax deductions
  // Example specific deductions (can store JSON blob if too many, or keep simple)
  healthInsuranceDeduction Decimal? @db.Decimal(10, 2)
  retirementDeduction      Decimal? @db.Decimal(10, 2)
  otherDeductions          Decimal? @db.Decimal(10, 2) // Catch-all or specific items

  totalTaxes     Decimal  @db.Decimal(12, 2) // Sum of all taxes
  // Example specific taxes (depends on jurisdiction)
  federalTax     Decimal? @db.Decimal(10, 2)
  stateTax       Decimal? @db.Decimal(10, 2)
  localTax       Decimal? @db.Decimal(10, 2)
  // Add social security, medicare etc. as needed

  // Leave Taken during this period (Connects to Leave system)
  leaveHoursUsed Decimal? @db.Decimal(6, 2)
  leaveType      LeaveType? // Which type of leave was primary if used

  // Payslip Generation
  // payslipUrl String? // Optionally store URL if generating PDFs elsewhere
  // Or generate payslip content dynamically from this record's data

  // Relationships
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict) // Link to the employee
  employeeId String   @db.Uuid

  payroll   Payroll @relation(fields: [payrollId], references: [id], onDelete: Cascade) // Link to the parent payroll run
  payrollId String  @db.Uuid

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, payrollId]) // Employee appears once per payroll
  @@index([employeeId])
  @@index([payrollId])
  @@map("employee_payrolls") // This table essentially represents the data for a single payslip
}


/// Stores the available leave balance for an employee for a specific leave type.
model LeaveBalance {
  id String @id @default(uuid()) @db.Uuid

  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String    @db.Uuid
  leaveType  LeaveType // Type of leave (ANNUAL, SICK, etc.)
  balance    Decimal   @db.Decimal(6, 2) // Current available balance (e.g., in hours or days)
  unit       String    @default("days") // Could be 'hours' or 'days'

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, leaveType]) // One balance record per employee per leave type
  @@index([employeeId])
  @@map("leave_balances")
}

/// Represents a request made by an employee to take leave.
model LeaveRequest {
  id String @id @default(uuid()) @db.Uuid

  employee   Employee           @relation("LeaveRequestedByEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String             @db.Uuid
  leaveType  LeaveType          // Type of leave requested
  startDate  DateTime           // Start date of leave
  endDate    DateTime           // End date of leave (inclusive)
  duration   Decimal            @db.Decimal(6, 2) // Requested duration (calculated, in balance units)
  reason     String?            @db.Text          // Reason provided by employee
  status     LeaveRequestStatus @default(PENDING)  // Current status of the request

  // Approval/Rejection Details
  processedById String?   @db.Uuid // User who approved/rejected
  processedBy   User?     @relation(name: "ApprovedLeaveByUser", fields: [processedById], references: [id], onDelete: SetNull) // Approver/Rejecter
   // Note: using one relation `ApprovedLeaveByUser` for simplicity, context given by status
  // Alternatively:
  // approvedById String?   @db.Uuid
  // approvedBy   User?     @relation("ApprovedLeaveByUser", fields: [approvedById], references: [id], onDelete: SetNull)
  // rejectedById String?   @db.Uuid
  // rejectedBy   User?     @relation("RejectedLeaveByUser", fields: [rejectedById], references: [id], onDelete: SetNull)

  processedAt   DateTime? // Timestamp of approval/rejection
  adminNotes    String?   @db.Text // Notes from the approver/rejecter
  User User[] @relation("RejectedLeaveByUser")

  // Timestamps
  createdAt DateTime @default(now()) // When the request was submitted
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([processedById])
  @@index([startDate, endDate])
  @@map("leave_requests")
  
}

// (Optional) Audit Log - Can be useful but adds complexity. Keep if needed.
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  timestamp  DateTime @default(now())
  userId     String?  @db.Uuid // User performing action (null if system)
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   // e.g., "PAYROLL_APPROVE", "EMPLOYEE_CREATE", "LEAVE_REQUEST_SUBMIT"
  entityType String   // e.g., "Payroll", "Employee", "LeaveRequest"
  entityId   String   @db.Uuid
  details    Json?    // Store before/after state or context
  ipAddress  String?

  @@index([timestamp])
  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}